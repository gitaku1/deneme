import dataiku

# Initialize DSS API client
client = dataiku.api_client()

# Get general settings
settings = client.get_general_settings()
raw_settings = settings.get_raw()

# CHANGE THESE
OLD = "clustera"
NEW = "clusterb"

changes = []


def replace_obj(obj, path="root"):
    """
    Recursively replace OLD with NEW
    inside dict/list string values
    """

    if isinstance(obj, dict):
        for k, v in obj.items():
            obj[k] = replace_obj(v, f"{path}.{k}")

    elif isinstance(obj, list):
        for i in range(len(obj)):
            obj[i] = replace_obj(obj[i], f"{path}[{i}]")

    elif isinstance(obj, str):
        if OLD in obj:
            new_val = obj.replace(OLD, NEW)
            changes.append((path, obj, new_val))
            return new_val

    return obj


# Target only container execution configs
exec_configs = (
    raw_settings
    .get("containerSettings", {})
    .get("executionConfigs", [])
)

for i, cfg in enumerate(exec_configs):
    replace_obj(cfg, f"executionConfigs[{i}]")


# Print planned changes
print("\n=== CHANGES APPLIED ===\n")

for path, old, new in changes:
    print(f"PATH : {path}")
    print(f"OLD  : {old}")
    print(f"NEW  : {new}")
    print("-" * 60)

print(f"\nTotal changes: {len(changes)}")


# Save changes to DSS
settings.save()

print("\nSettings saved successfully.")
