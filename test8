#!/bin/bash
# check_parquet_parallel.sh
# Kullanım: ./check_parquet_parallel.sh /user/ali <paralel_sayı>
# Örnek: ./check_parquet_parallel.sh /user/ali 10

HDFS_PATH=$1
PARALLEL=${2:-5}   # paralel iş sayısı, default 5

# HDFS altındaki tüm dosyaları listele
hdfs dfs -ls -R "$HDFS_PATH" | awk '{print $8}' | \
xargs -n 1 -P $PARALLEL -I {} bash -c '
    f="{}"
    # Dosya boyutu
    len=$(hdfs dfs -stat %b "$f" 2>/dev/null)
    if [ -z "$len" ] || [ "$len" -lt 8 ]; then
        echo "CORRUPT: $f (too small or stat failed)"
        exit 0
    fi

    # İlk 4 byte
    head=$(hdfs dfs -cat "$f" | dd bs=1 count=4 2>/dev/null | xxd -p)
    # Son 4 byte
    tail=$(hdfs dfs -cat "$f" | dd bs=1 skip=$((len-4)) count=4 2>/dev/null | xxd -p)

    if [ "$head" != "50415231" ] || [ "$tail" != "50415231" ]; then
        echo "CORRUPT: $f"
    fi
'
