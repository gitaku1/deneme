#!/bin/bash
# RStudio Server başlangıç scripti - root üzerinden çalışacak
set -e

USER=dataiku
HOME=/home/dataiku
export XDG_CONFIG_DIRS=$HOME/workspace/user-versioned/settings/rstudio

# Config dizini yoksa oluştur
if [ ! -d "$HOME/workspace/user-versioned/settings/rstudio" ]; then
    mkdir -p $HOME/workspace/user-versioned/settings/rstudio/rstudio
    cat << 'EOF' > $HOME/workspace/user-versioned/settings/rstudio/rstudio/rstudio-prefs.json
{
    "initial_working_directory": "/home/dataiku/workspace",
    "posix_terminal_shell": "bash"
}
EOF
    chown -R $USER:$USER $HOME/workspace/user-versioned/settings/rstudio
fi

# R code envs ekle
if [ -d /opt/dataiku/r-code-envs ]; then
    for envdir in /opt/dataiku/r-code-envs/*; do
        if [ -d "$envdir/R.lib" ]; then
            export R_LIBS_USER=$envdir/R.lib:$R_LIBS_USER
        fi
    done
fi

# Passthrough environment variables
env | egrep "DKU_(DIP|R_LIBS_USER|XDG_CONFIG)" > $HOME/.Renviron

# Bind address ayarı
if [ "$DKU_CODE_STUDIO_IS_PUBLIC_PORT_9292" = "1" ]; then
    BIND_ADDR="0.0.0.0"
else
    BIND_ADDR="127.0.0.1"
fi

# RStudio Server başlat
exec /usr/lib/rstudio-server/bin/rserver \
    --server-daemonize=0 \
    --auth-none=1 \
    --www-address=$BIND_ADDR \
    --www-port=9292 \
    --auth-minimum-user-id=500 \
    --server-user=$USER \
    --server-data-dir=$HOME/.rstudio-server-run \
    --server-pid-file=$HOME/.rstudio-server.pid \
    --www-frame-origin=* \
    --www-root-path=/
