FROM rockylinux:8   # veya istediğin Linux base image

# Root olarak başla
USER root

# R ve gerekli bağımlılıkları kur
RUN yum install -y \
    R \
    sudo \
    wget \
    openssl \
    libuuid \
    psmisc \
    which \
    && yum clean all

# dataiku kullanıcısı oluştur
RUN useradd -ms /bin/bash dataiku

# Scriptin ihtiyaç duyduğu dizinleri oluştur
RUN mkdir -p /opt/dataiku/r-code-envs \
    && mkdir -p /home/dataiku/workspace/user-versioned/settings/rstudio/rstudio \
    && mkdir -p /home/dataiku/.rstudio-server-run \
    && chown -R dataiku:dataiku /home/dataiku /opt/dataiku/r-code-envs

# RStudio Server rpm indir ve kur (RHEL/CentOS 8 için örnek)
RUN wget https://download2.rstudio.org/server/centos8/x86_64/rstudio-server-rhel-2024.09.1-394-x86_64.rpm -O /tmp/rstudio-server.rpm && \
    yum install -y /tmp/rstudio-server.rpm && \
    rm -f /tmp/rstudio-server.rpm

# rstudio-entrypoint.sh'yi image içine kopyala
COPY rstudio-entrypoint.sh /opt/dataiku/rstudio-entrypoint.sh
RUN chmod +x /opt/dataiku/rstudio-entrypoint.sh \
    && chown dataiku:dataiku /opt/dataiku/rstudio-entrypoint.sh

# Çalışma dizini ve kullanıcı ayarı
USER dataiku
WORKDIR /home/dataiku

# RStudio Server portu
EXPOSE 9292

# Entrypoint
ENTRYPOINT ["/opt/dataiku/rstudio-entrypoint.sh"]
