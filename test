import os
import nbformat
from bs4 import BeautifulSoup
from nbconvert import HTMLExporter
from weasyprint import HTML, CSS

# PDF için çıkış yolu
IPYNB_PATH = "dosya.ipynb"
PDF_PATH = "output.pdf"

# HTML çıktısını üret
with open(IPYNB_PATH, "r", encoding="utf-8") as f:
    notebook = nbformat.read(f, as_version=4)

# Sadece çıktı hücrelerini al (kodları değil)
for cell in notebook["cells"]:
    if cell["cell_type"] == "code":
        cell["source"] = ""

# HTML export
html_exporter = HTMLExporter()
html_exporter.template_name = "lab"  # JupyterLab stili
(body, resources) = html_exporter.from_notebook_node(notebook)

# BeautifulSoup ile işleme
soup = BeautifulSoup(body, "html.parser")

# Sayfanın genel yazı boyutu ve görünümünü küçült
style_tag = soup.new_tag("style")
style_tag.string = """
body {
    font-size: 9pt !important;
    margin: 10mm;
}
.output {
    font-size: 7.5pt !important;
    overflow-x: auto !important;
    word-wrap: break-word !important;
    max-width: 100%;
}
.output pre {
    white-space: pre-wrap !important;
    font-size: 7.5pt !important;
}
table {
    font-size: 7pt;
    table-layout: auto !important;
    word-break: break-word !important;
    border-collapse: collapse;
    width: 100%;
}
th, td {
    padding: 2px;
    border: 1px solid #ddd;
}
@page {
    size: A4 portrait;
    margin: 10mm;
}
"""
soup.head.append(style_tag)

# Uzun tabloları yatay göster (çok genişse)
for table in soup.find_all("table"):
    table["style"] = "font-size:7pt; width: 100%; table-layout:auto;"

# Output hücrelerini sınırlı genişlikte tutmak için div ekle
for div in soup.find_all("div", class_="output"):
    div["style"] = "max-width: 100%; overflow-x: auto; font-size: 7pt;"

# Boş tag'leri temizle
for tag in soup.find_all():
    if not tag.get_text(strip=True) and not (tag.name and tag.name.startswith("img")):
        tag.decompose()

# HTML’yi PDF’ye çevir
full_html = str(soup)

HTML(string=full_html).write_pdf(
    PDF_PATH,
    stylesheets=[CSS(string='@page { size: A4; margin: 10mm; }')],
    zoom=1.0
)

print(f"PDF başarıyla oluşturuldu: {PDF_PATH}")
