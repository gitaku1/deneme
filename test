import asyncio
import nest_asyncio
from pyppeteer import launch
import nbformat
from nbconvert import HTMLExporter
import os

# Ortam ayarlarÄ±
os.environ['PYPPETEER_SKIP_CHROMIUM_DOWNLOAD'] = '1'

# Dosya yollarÄ±
IPYNB_PATH = "/veri01/ipynbdirectory/notebook.ipynb"
HTML_PATH = "/veri01/ipynbdirectory/notebook_rendered.html"
PDF_OUTPUT_PATH = "/veri01/ipynbdirectory/notebook.pdf"
CHROME_PATH = "/veri01/chrome-linux/chrome"  # Kendi Chrome'un

# Notebook'u HTML'e Ã§evir
with open(IPYNB_PATH, "r", encoding="utf-8") as f:
    nb_content = f.read()
nb_node = nbformat.reads(nb_content, as_version=4)
html_exporter = HTMLExporter()
html_exporter.exclude_input = False
html_exporter.exclude_output_prompt = True
html_exporter.exclude_input_prompt = True

# CSS: geniÅŸlik sÄ±ÄŸsÄ±n, fontlar uygun olsun
extra_css = """
<style>
body {
    margin: 0 auto;
    padding: 1cm;
    font-size: 11pt;
    width: 100%;
    overflow-x: auto;
}
.output_area pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}
.output_area {
    max-width: 100%;
    overflow-x: auto;
}
table {
    width: 100% !important;
    table-layout: fixed;
    word-wrap: break-word;
}
</style>
"""

html_data, _ = html_exporter.from_notebook_node(nb_node)
html_data = html_data.replace('</head>', f'{extra_css}</head>')

# HTML dosyasÄ±nÄ± kaydet
with open(HTML_PATH, "w", encoding="utf-8") as f:
    f.write(html_data)

# Async dÃ¶ngÃ¼ baÅŸlatÄ±cÄ± (Jupyter uyumlu)
nest_asyncio.apply()

# PDF oluÅŸturucu fonksiyon
async def convert_html_to_pdf():
    print("ðŸ“¦ Chrome baÅŸlatÄ±lÄ±yor...")
    browser = await launch(
        executablePath=CHROME_PATH,
        headless=True,
        dumpio=True,
        args=[
            "--no-sandbox",
            "--disable-gpu",
            "--disable-dev-shm-usage",
            "--window-size=1920,1080"
        ],
        userDataDir="/tmp/chrome-user-data",
        timeout=60000
    )
    page = await browser.newPage()
    await page.goto(f"file://{HTML_PATH}", {"waitUntil": "networkidle0"})
    await page.pdf({
        "path": PDF_OUTPUT_PATH,
        "format": "A4",
        "margin": {"top": "0.5in", "bottom": "0.5in", "left": "0.5in", "right": "0.5in"},
        "printBackground": True,
        "scale": 0.95
    })
    await browser.close()
    print(f"âœ… PDF baÅŸarÄ±yla oluÅŸturuldu: {PDF_OUTPUT_PATH}")

# KoÅŸ
asyncio.get_event_loop().run_until_complete(convert_html_to_pdf())
