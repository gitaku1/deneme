import asyncio
import nest_asyncio
import nbformat
from nbconvert import HTMLExporter
from pyppeteer import launch, errors as pyppeteer_errors

NOTEBOOK_PATH = "notebook_adi.ipynb"
HTML_PATH = "notebook.html"
PDF_PATH = "notebook.pdf"
CHROME_PATH = "/veri/01/chrome"  # Yerel Chromium path'i

# HTML Ã§Ä±ktÄ±sÄ± oluÅŸtur
def convert_notebook_to_html():
    with open(NOTEBOOK_PATH, "r") as f:
        nb_content = f.read()

    nb_node = nbformat.reads(nb_content, as_version=4)
    html_exporter = HTMLExporter()
    html_data, _ = html_exporter.from_notebook_node(nb_node)

    # YazdÄ±rma dostu CSS
    custom_css = """
    <style>
    @media print {
        html, body {
            width: 100%;
            margin: 0;
            padding: 0;
            font-size: 10px;
            -webkit-print-color-adjust: exact;
        }

        .output_area, pre, code {
            font-size: 8px !important;
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            overflow-x: auto !important;
        }

        .output_area {
            transform: scale(0.75);
            transform-origin: top left;
            max-width: 140%;
        }

        table {
            width: 100% !important;
            table-layout: fixed;
            font-size: 8px;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #999;
            padding: 2px;
            word-break: break-word;
        }

        .container, .cell {
            margin: 0 !important;
            padding: 0 !important;
            page-break-inside: avoid;
        }
    }
    </style>
    """

    if "</head>" in html_data:
        html_data = html_data.replace("</head>", f"{custom_css}</head>")
    else:
        html_data = custom_css + html_data

    with open(HTML_PATH, "w", encoding="utf-8") as f:
        f.write(html_data)

# HTMLâ€™yi PDFâ€™e dÃ¶nÃ¼ÅŸtÃ¼r
async def convert_html_to_pdf():
    try:
        print("âœ… Chromium baÅŸlatÄ±lÄ±yor...")
        browser = await launch(
            headless=True,
            executablePath=CHROME_PATH,
            args=["--no-sandbox", "--disable-setuid-sandbox"]
        )
        page = await browser.newPage()

        print("ðŸ”„ Sayfa yÃ¼kleniyor...")
        await asyncio.wait_for(
            page.goto(f"file://{HTML_PATH}", {"waitUntil": "networkidle0"}),
            timeout=60
        )

        print("ðŸ“„ PDF oluÅŸturuluyor...")
        await asyncio.wait_for(
            page.pdf({
                "path": PDF_PATH,
                "format": "A4",
                "printBackground": True,
                "margin": {
                    "top": "10mm",
                    "bottom": "10mm",
                    "left": "5mm",
                    "right": "5mm"
                },
                "scale": 0.75
            }),
            timeout=60
        )

        print("âœ… PDF baÅŸarÄ±yla oluÅŸturuldu.")
        await browser.close()

    except asyncio.TimeoutError:
        print("â›” HATA: Ä°ÅŸlem zaman aÅŸÄ±mÄ±na uÄŸradÄ±! Sayfa yÃ¼kleme ya da PDF oluÅŸturma Ã§ok uzun sÃ¼rdÃ¼.")
    except pyppeteer_errors.BrowserError as e:
        print(f"â›” Chromium baÅŸlatÄ±lamadÄ±: {e}")
    except Exception as e:
        print(f"â›” Beklenmeyen hata oluÅŸtu: {e}")

# Ã‡alÄ±ÅŸtÄ±r
def main():
    print("ðŸ“„ HTML dÃ¶nÃ¼ÅŸtÃ¼rme baÅŸlÄ±yor...")
    convert_notebook_to_html()

    print("ðŸ“¦ PDF'e dÃ¶nÃ¼ÅŸtÃ¼rme baÅŸlÄ±yor...")
    nest_asyncio.apply()
    asyncio.get_event_loop().run_until_complete(convert_html_to_pdf())

if __name__ == "__main__":
    main()
