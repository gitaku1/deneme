-- 1️⃣ Parametreler
DEFINE DB_NAME = 'DB_NAME';        -- Silmek istediğin DB
DEFINE TABLE_NAME = 'TABLE_NAME';  -- Silmek istediğin tablo

-- 2️⃣ DB_ID ve TBL_ID'yi bul
VARIABLE DB_ID NUMBER;
VARIABLE TBL_ID NUMBER;

BEGIN
    SELECT DB_ID INTO :DB_ID FROM DBS WHERE NAME = '&DB_NAME';
    SELECT TBL_ID INTO :TBL_ID FROM TBLS WHERE TBL_NAME = '&TABLE_NAME' AND DB_ID = :DB_ID;
END;
/

-- 3️⃣ Partition ID’lerini geçici tabloya al
CREATE GLOBAL TEMPORARY TABLE TMP_PART_IDS (PART_ID NUMBER) ON COMMIT PRESERVE ROWS;

INSERT INTO TMP_PART_IDS (PART_ID)
SELECT PART_ID FROM PARTITIONS WHERE TBL_ID = :TBL_ID;

COMMIT;

-- 4️⃣ Bozuk privilege kayıtlarını sil
DELETE FROM MPartitionPrivilege WHERE PART_ID IN (SELECT PART_ID FROM TMP_PART_IDS);
DELETE FROM MTablePrivilege WHERE TBL_ID = :TBL_ID;

COMMIT;

-- 5️⃣ Partition ve storage kayıtlarını temizle
DELETE FROM PARTITIONS WHERE TBL_ID = :TBL_ID;
DELETE FROM SDS WHERE SD_ID IN (SELECT SD_ID FROM TBLS WHERE TBL_ID = :TBL_ID);

COMMIT;

-- 6️⃣ Tablo kaydını sil
DELETE FROM TBLS WHERE TBL_ID = :TBL_ID;

COMMIT;

-- 7️⃣ Geçici tabloyu temizle
DROP TABLE TMP_PART_IDS;

-- 8️⃣ Hue / Impala tarafında metadata’yı yenile
-- Impala terminalinde:
-- invalidate metadata;
