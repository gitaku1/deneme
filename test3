FROM rockylinux:8

# Root olarak başla
USER root

# Gerekli paketler
RUN dnf -y install epel-release && \
    dnf -y install \
      R \
      wget \
      sudo \
      libcurl-devel \
      openssl-devel \
      libxml2-devel \
      && dnf clean all

# RStudio Server rpm indir ve kur
RUN wget https://download2.rstudio.org/server/centos8/x86_64/rstudio-server-rhel-2024.09.1-394-x86_64.rpm -O /tmp/rstudio-server.rpm && \
    dnf -y install /tmp/rstudio-server.rpm && \
    rm -f /tmp/rstudio-server.rpm

# dataiku kullanıcısını oluştur (UID/GID sen ayarlayabilirsin, ben 1000 verdim)
RUN useradd -m -u 1000 -d /home/dataiku dataiku && \
    echo "dataiku:dataiku" | chpasswd && \
    echo "dataiku ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Ortam değişkenleri
ENV USER=dataiku \
    HOME=/home/dataiku \
    XDG_CONFIG_DIRS=/home/dataiku/workspace/user-versioned/settings/rstudio

# Entrypoint script kopyala
COPY rstudio-entrypoint.sh /usr/local/bin/rstudio-entrypoint.sh
RUN chmod +x /usr/local/bin/rstudio-entrypoint.sh && \
    chown dataiku:dataiku /usr/local/bin/rstudio-entrypoint.sh

# dataiku kullanıcısına geç
USER dataiku
WORKDIR /home/dataiku

EXPOSE 9292

ENTRYPOINT ["/usr/local/bin/rstudio-entrypoint.sh"]
