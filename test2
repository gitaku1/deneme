import asyncio
import os
from pyppeteer import launch
from nbconvert import HTMLExporter
import nbformat

# 1. Girdi defteri (senin notebook dosyan)
notebook_path = "defterim.ipynb"  # kendi dosya adÄ±nÄ± buraya yaz
html_path = "gecici.html"
pdf_path = "cikti.pdf"
chrome_path = "/veri01/chrome-linux/chrome"  # senin Chrome yolun

# 2. Notebook'u HTML'e dÃ¶nÃ¼ÅŸtÃ¼r
print("Notebook HTML'e dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼yor...")
with open(notebook_path) as f:
    nb_node = nbformat.read(f, as_version=4)

html_exporter = HTMLExporter()
body, _ = html_exporter.from_notebook_node(nb_node)

# 3. GeniÅŸ tablolar iÃ§in CSS ekle (scroll yerine geniÅŸlik kÄ±sÄ±tlamasÄ±nÄ± kaldÄ±rÄ±yoruz)
extra_css = """
<style>
/* TÃ¼m hÃ¼creleri ve tablolarÄ± dÃ¼zgÃ¼nce sayfaya sÄ±ÄŸdÄ±r */
.output pre, .output_area pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* GeniÅŸ tablolarÄ± sayfa geniÅŸliÄŸine zorla */
.output_area table {
    display: block;
    width: 100%;
    overflow-x: auto;
    font-size: 10pt;
    word-break: break-word;
}

/* Kod hÃ¼creleri ve yazÄ±lar iÃ§in yazÄ± boyutunu azalt */
div.cell {
    font-size: 10pt;
}
</style>
"""

body = body.replace('</head>', extra_css + '</head>')

with open(html_path, 'w', encoding='utf-8') as f:
    f.write(body)

print(f"HTML dosyasÄ± oluÅŸturuldu: {html_path}")

# 4. PDF'e dÃ¶nÃ¼ÅŸtÃ¼rme fonksiyonu
async def html_to_pdf():
    print("Chrome baÅŸlatÄ±lÄ±yor...")
    browser = await launch(
        executablePath=chrome_path,
        headless=True,
        args=["--no-sandbox"]
    )
    page = await browser.newPage()

    file_url = f'file://{os.path.abspath(html_path)}'
    print(f"HTML yÃ¼kleniyor: {file_url}")
    await page.goto(file_url, {'waitUntil': 'networkidle0'})

    # PDF oluÅŸturuluyor
    print("PDF dosyasÄ± oluÅŸturuluyor (yatay sayfa)...")
    await page.pdf({
        'path': pdf_path,
        'format': 'A4',
        'printBackground': True,
        'landscape': True,  # ğŸ”¥ yatay sayfa formatÄ±
        'scale': 0.9,       # biraz kÃ¼Ã§Ã¼lterek sÄ±ÄŸdÄ±r
        'margin': {
            'top': '0.5in',
            'bottom': '0.5in',
            'left': '0.5in',
            'right': '0.5in'
        }
    })
    await browser.close()
    print(f"PDF baÅŸarÄ±yla oluÅŸturuldu: {pdf_path}")

# 5. PDF oluÅŸtur
asyncio.get_event_loop().run_until_complete(html_to_pdf())
