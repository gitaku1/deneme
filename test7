#!/bin/bash
set -e

USER=dataiku
HOME=/home/dataiku
export XDG_CONFIG_DIRS="$HOME/workspace/user-versioned/settings/rstudio"

# Initial config set-up (sadece ilk ba≈ülatmada)
if [ ! -d "$XDG_CONFIG_DIRS/rstudio" ]; then
    mkdir -p "$XDG_CONFIG_DIRS/rstudio"
    cat << 'EOF' > "$XDG_CONFIG_DIRS/rstudio/rstudio-prefs.json"
{
  "initial_working_directory": "/home/dataiku/workspace",
  "posix_terminal_shell": "bash"
}
EOF
fi

# Add all the code envs to R (varsa)
if [ -d "/opt/dataiku/r-code-envs" ]; then
    for i in $(ls -r /opt/dataiku/r-code-envs); do
        echo "Adding code env $i"
        export R_LIBS_USER="/opt/dataiku/r-code-envs/$i/R.lib:$R_LIBS_USER"
    done
fi

# Pass env vars to Studio
env | egrep "DKU_(DIP|R_LIBS_USER|XDG_CONFIG)" > "$HOME/.Renviron"

# Base URI / Bind address
BASE_URI=$(eval echo "SDKU_CODE_STUDIO_BROWSER_PATH_9292")
if [ "${SDKU_CODE_STUDIO_IS_PUBLIC_PORT_9292}" = "1" ]; then
    BIND_ADDR="0.0.0.0"
else
    BIND_ADDR="127.0.0.1"
fi

# Start RStudio Server as dataiku
exec /usr/lib/rstudio-server/bin/rserver \
    --server-daemonize=0 \
    --auth-none=1 \
    --www-address="$BIND_ADDR" \
    --www-port=9292 \
    --auth-minimum-user-id=500 \
    --www-frame-origin="*" \
    --www-root-path="$BASE_URI" \
    --server-user=dataiku \
    --server-data-dir="$HOME/.rstudio-server-run" \
    --server-pid-file="$HOME/.rstudio-server.pid"
