# Base image olarak R ve Dataiku dependencies içeren bir Linux kullanıyoruz
FROM rockylinux:8

# Root olarak devam
USER root

# Temel paketler ve RStudio Server için gerekli kütüphaneler
RUN yum update -y && \
    yum install -y \
    wget \
    sudo \
    libX11 \
    libXt \
    libpng \
    libjpeg-turbo \
    libtiff \
    openssl \
    libuuid \
    bzip2 \
    tar \
    gzip \
    bash \
    which \
    && yum clean all

# Dataiku user oluştur ve UID/ GID ayarla
RUN groupadd -g 500 dataiku && \
    useradd -m -u 500 -g 500 -s /bin/bash dataiku

# RStudio Server binary ve script kopyala
COPY rstudio-entrypoint.sh /opt/dataiku/rstudio-entrypoint.sh
RUN chmod +x /opt/dataiku/rstudio-entrypoint.sh

# RStudio Server için gerekli dizinler
RUN mkdir -p /home/dataiku/.rstudio-server-run \
    && mkdir -p /home/dataiku/workspace/user-versioned/settings/rstudio/rstudio \
    && chown -R dataiku:dataiku /home/dataiku/.rstudio-server-run \
    && chown -R dataiku:dataiku /home/dataiku/workspace \
    && chmod -R 700 /home/dataiku/.rstudio-server-run \
    && chmod -R 700 /home/dataiku/workspace

# R code envs klasörü (varsa)
RUN mkdir -p /opt/dataiku/r-code-envs && chown -R dataiku:dataiku /opt/dataiku/r-code-envs

# Port aç
EXPOSE 9292

# Entrypoint
ENTRYPOINT ["/opt/dataiku/rstudio-entrypoint.sh"]
